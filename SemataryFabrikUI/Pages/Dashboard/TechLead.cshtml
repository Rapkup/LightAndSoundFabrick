@page
@using SemataryFabrick.Domain.Entities.Enums
@using SemataryFabrick.Domain.Entities.Models.OrderModels
@model TechLeadModel
@{
    ViewData["Title"] = "Tech Lead Dashboard";
    Layout = "~/Pages/Dashboard/_DashboardLayout.cshtml";
}

<div class="">
    <div class="pc-content">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#active">
                                    Активные (@Model.ActiveOrders.Count)
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#processed">
                                    Выполненные (@Model.ProcessedOrders.Count)
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#history">
                                    История (@Model.HistoryOrders.Count)
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="pills-tabContent">
                            <!-- Active Orders -->
                            <div class="tab-pane fade show active" id="active">
                                <div class="row g-4">
                                    @foreach (var order in Model.ActiveOrders)
                                    {
                                        <div class="col-xxl-4 col-lg-6">
                                            <div class="card order-card hover-shadow">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                                        <h5 class="card-title mb-0">@order.EventAddress</h5>
                                                        <span class="badge bg-primary">#@order.Id.ToString().Substring(0, 8)</span>
                                                    </div>

                                                    <div class="order-details mb-3">
                                                        <p class="text-muted small mb-0">@Html.Raw(Model.GetOrderDescription(order))</p>
                                                    </div>

                                                    @if (order.OrderCrews?.Any(c => c.WorkTaskAssignments?.Any() == true) == true)
                                                    {
                                                        <div class="progress-wrapper mb-3">
                                                            <div class="d-flex justify-content-between small mb-2">
                                                                <span>Прогресс выполнения:</span>
                                                                <span>@Model.CalculateProgress(order)%</span>
                                                            </div>
                                                            <div class="progress" style="height: 8px;">
                                                                <div class="progress-bar bg-success"
                                                                     style="width: @Model.CalculateProgress(order)%"
                                                                     role="progressbar"></div>
                                                            </div>
                                                        </div>
                                                    }

                                                    <div class="d-flex gap-2 flex-wrap">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#orderDetailsModal"
                                                                onclick="loadOrderDetails('@order.Id')">
                                                            <i class="ti ti-info-circle me-1"></i>Подробнее
                                                        </button>
                                                        <button class="btn btn-sm btn-primary"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#manageCrewModal"
                                                                onclick="setSelectedOrder('@order.Id')">
                                                            <i class="ti ti-users me-1"></i>Команды (@(order.OrderCrews?.Count ?? 0))
                                                        </button>
                                                        <form method="post" class="flex-grow-1">
                                                            <button type="submit"
                                                                    class="btn btn-sm btn-success w-100"
                                                                    asp-page-handler="CompleteOrder"
                                                                    asp-route-orderId="@order.Id">
                                                                Завершить
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Processed Orders -->
                            <div class="tab-pane fade" id="processed">
                                <div class="row g-4">
                                    @foreach (var order in Model.ProcessedOrders)
                                    {
                                        <div class="col-xxl-4 col-lg-6">
                                            <div class="card order-card hover-shadow">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                                        <h5 class="card-title mb-0">@order.EventAddress</h5>
                                                        <span class="badge bg-warning">#@order.Id.ToString().Substring(0, 8)</span>
                                                    </div>

                                                    <div class="order-details mb-3">
                                                        <p class="text-muted small mb-0">@Html.Raw(Model.GetOrderDescription(order))</p>
                                                    </div>

                                                    <div class="d-flex gap-2 flex-wrap">
                                                        <form method="post">
                                                            <button type="submit"
                                                                    class="btn btn-sm btn-warning w-100"
                                                                    asp-page-handler="ReturnOrder"
                                                                    asp-route-orderId="@order.Id">
                                                                <i class="ti ti-arrow-back me-1"></i>Вернуть в работу
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- History -->
                            <div class="tab-pane fade" id="history">
                                <div class="row g-4">
                                    @foreach (var order in Model.HistoryOrders)
                                    {
                                        <div class="col-xxl-4 col-lg-6">
                                            <div class="card order-card hover-shadow">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                                        <h5 class="card-title mb-0">@order.EventAddress</h5>
                                                        <span class="badge bg-success">#@order.Id.ToString().Substring(0, 8)</span>
                                                    </div>

                                                    <div class="order-details mb-3">
                                                        <p class="text-muted small mb-0">@Html.Raw(Model.GetOrderDescription(order))</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
@await Html.PartialAsync("_ManageCrewModal", Model)
@await Html.PartialAsync("_ManageTasksModal", Model)
@await Html.PartialAsync("_OrderDetailsModal", new OrderBase())
@await Html.PartialAsync("_ManageWorkersModal", Model)

@section Styles {
    <style>
        .order-card {
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

            .order-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            }

            .order-card::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: var(--bs-primary);
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .order-card:hover::after {
                opacity: 1;
            }

        .progress-wrapper {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }

        .order-details {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            line-height: 1.6;
            font-size: 0.9rem;
        }

            .order-details p {
                margin-bottom: 0.25rem;
            }

        .crew-card {
            transition: transform 0.2s;
            border-left: 4px solid var(--bs-primary);
        }

            .crew-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            }

        .tasks-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .workers-list {
            min-height: 80px;
        }
    </style>
}

@section Scripts {
    <script>

                // В секции Scripts добавьте
        document.querySelectorAll('.worker-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const checkbox = card.querySelector('.form-check-input');
                checkbox.checked = !checkbox.checked;
                card.classList.toggle('bg-primary-bg-subtle', checkbox.checked);
            });
        });

        function setSelectedOrder(orderId) {
            document.getElementById('SelectedOrderId').value = orderId;
        }

        function setSelectedCrew(crewId) {
            document.getElementById('SelectedCrewId').value = crewId;
        }

        function loadOrderDetails(orderId) {
            fetch(`?handler=OrderDetails&orderId=${orderId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    const container = document.getElementById('orderDetailsContent');
                    container.innerHTML = html;
                    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
                })
                .catch(error => console.error('Ошибка загрузки:', error));
        }

        // Инициализация прогресс-баров
        document.querySelectorAll('.progress-bar').forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => bar.style.width = width, 100);
        });
    </script>
}