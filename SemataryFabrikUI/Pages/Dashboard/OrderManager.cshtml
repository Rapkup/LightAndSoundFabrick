@page
@using SemataryFabrick.Application.Contracts.Services
@using SemataryFabrick.Application.Entities.DTOs.OrderDtos
@using SemataryFabrick.Domain.Entities.Enums
@model SemataryFabrikUI.Pages.Dashboard.OrderMangerModel
@inject IUserService UserService
@inject IWorkTaskService WorkTaskService
@{
    ViewData["Title"] = "Order Manager";
    Layout = "~/Pages/Dashboard/_DashboardLayout.cshtml";
}

<div class="pc-content">
    <div class="page-header">
        <div class="page-block">
            <div class="row align-items-center">
                <div class="col-md-12">
                    <div class="page-header-title">
                        <h5 class="mb-0">Order Management</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-3" id="ordersTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="new-tab" data-bs-toggle="tab" href="#new" role="tab">
                        Новый заказ (@Model.NewOrders.Count)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="progress-tab" data-bs-toggle="tab" href="#progress" role="tab">
                        Активные заказы  (@Model.InProgressOrders.Count)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="payment-tab" data-bs-toggle="tab" href="#payment" role="tab">
                        Ожидают подтверждения оплаты (@Model.PendingPaymentOrders.Count)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="rent-tab" data-bs-toggle="tab" href="#rent" role="tab">
                        Заказы аренды (@Model.RentOrders.Count)
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="ordersTabContent">
                <!-- New Orders Tab -->
                <div class="tab-pane fade show active" id="new" role="tabpanel">
                    @foreach (var order in Model.NewOrders)
                    {
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Order #@order.Id.ToString().Substring(0, 8)</span>
                                <span class="badge bg-primary">@order.OrderState</span>
                            </div>
                            <div class="card-body">
                                <form method="post">
                                    <input type="hidden" asp-for="UpdateModel.OrderId" value="@order.Id" />
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Тех специалист</label>
                                            <select asp-for="UpdateModel.TechLeadId" class="form-control"
                                                    asp-items="@(UserService.GetTechLeadsSelectList( await UserService.GetTechLeads()))">
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Итоговая цена</label>
                                            <input asp-for="UpdateModel.TotalPrice" class="form-control" value="@order.TotalPrice" />
                                        </div>
                                        <div class="col-md-4 d-flex align-items-end">
                                            <div class="w-100">
                                                <button type="submit" class="btn btn-primary w-100">Обновить данные</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                                <div class="mt-3 d-flex justify-content-between">
                                    <h6>Позиции:</h6>
                                    <button type="button" class="btn btn-info btn-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#descriptionModal-@order.Id">
                                        Описание
                                    </button>
                                </div>

                                <!-- Description Modal -->
                                <div class="modal fade" id="descriptionModal-@order.Id" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Позиции заказа #@order.Id.ToString().Substring(0,8)</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover align-middle">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Фото</th>
                                                                <th>Название</th>
                                                                <th>Цена</th>
                                                                <th>Кол-во</th>
                                                                <th>Действия</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @if (order.OrderItems != null && order.OrderItems.Any())
                                                            {
                                                                @foreach (var item in order.OrderItems)
                                                                {
                                                                    <tr>
                                                                        <td>
                                                                            <img src="/images/items/@item.Product.ImageName" 
                                                                                 alt="@item.Product.Name" 
                                                                                 width="50" 
                                                                                 class="img-thumbnail">
                                                                        </td>
                                                                        <td>@item.Product.Name</td>
                                                                        <td>@item.Product.Price.ToString("C")</td>
                                                                        <td>@item.Quantity</td>
                                                                        <td>
                                                                            <div class="btn-group" role="group">
                                                                                <button type="button" 
                                                                                        class="btn btn-sm btn-primary" 
                                                                                        data-bs-toggle="modal" 
                                                                                        data-bs-target="#editItemModal-@item.Id">
                                                                                    Изменить
                                                                                </button>
                                                                                <form method="post" asp-page-handler="RemoveItem">
                                                                                    <input type="hidden" name="orderItemId" value="@item.Id" />
                                                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                                                        Удалить
                                                                                    </button>
                                                                                </form>
                                                                            </div>
                                                                        </td>
                                                                    </tr>

                                                                    <!-- Edit Item Modal -->
                                                                    <div class="modal fade" id="editItemModal-@item.Id" tabindex="-1" aria-hidden="true">
                                                                        <div class="modal-dialog">
                                                                            <form method="post" asp-page-handler="UpdateItem">
                                                                                <div class="modal-content">
                                                                                    <div class="modal-header">
                                                                                        <h5 class="modal-title">Изменить количество</h5>
                                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                                    </div>
                                                                                    <div class="modal-body">
                                                                                        <input type="hidden" name="orderItemId" value="@item.Id" />
                                                                                        <div class="mb-3">
                                                                                            <label class="form-label">Количество</label>
                                                                                            <input type="number" 
                                                                                                   name="quantity" 
                                                                                                   class="form-control" 
                                                                                                   value="@item.Quantity" 
                                                                                                   min="1" 
                                                                                                   max="100">
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="modal-footer">
                                                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                                                                        <button type="submit" class="btn btn-primary">Сохранить</button>
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <tr>
                                                                    <td colspan="5" class="text-center">Нет позиций в заказе</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>

                                                <button type="button" class="btn btn-success mt-3" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#addItemModal-@order.Id">
                                                    Добавить товар
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add Item Modal -->
                                <div class="modal fade" id="addItemModal-@order.Id" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <form method="post" asp-page-handler="AddItem">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Добавить товар в заказ #@order.Id.ToString().Substring(0,8)</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <input type="hidden" name="AddItemModel.OrderId" value="@order.Id" />
                                                    
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <label class="form-label">Категория</label>
                                                            <select id="categorySelect-@order.Id" 
                                                                    class="form-control" 
                                                                    onchange="updateSubcategories('@order.Id')">
                                                                <option value="">Выберите категорию</option>
                                                                @foreach (var category in Model.Categories)
                                                                {
                                                                    <option value="@category.Id">@category.Name</option>
                                                                }
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Подкатегория</label>
                                                            <select id="subcategorySelect-@order.Id" 
                                                                    class="form-control" 
                                                                    onchange="updateProducts('@order.Id')">
                                                                <option value="">Сначала выберите категорию</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Товар</label>
                                                            <select asp-for="AddItemModel.ProductId" 
                                                                    class="form-control" 
                                                                    id="productSelect-@order.Id">
                                                                <option value="">Сначала выберите подкатегорию</option>
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <div class="mt-3">
                                                        <label class="form-label">Количество</label>
                                                        <input asp-for="AddItemModel.Quantity" 
                                                               class="form-control" 
                                                               min="1" 
                                                               max="100" 
                                                               value="1" />
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                                    <button type="submit" class="btn btn-primary">Добавить</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- In Progress Tab -->
                <div class="tab-pane fade" id="progress" role="tabpanel">
                    @foreach (var order in Model.InProgressOrders)
                    {
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Order #@order.Id.ToString().Substring(0, 8)</span>
                                <span class="badge bg-warning">@order.OrderState</span>
                            </div>
                            <div class="card-body">
                                @{
                                    var progress = await WorkTaskService.GetOrderProgressAsync(order.Id);
                                }
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Прогресс выполнения:</h6>
                                    @if (progress.TotalTasks > 0)
                                    {
                                        <span>@progress.CompletedTasks/@progress.TotalTasks задач выполнено</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Работа еще не начата</span>
                                    }
                                </div>

                                <button type="button" class="btn btn-info btn-sm" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#descriptionModal-@order.Id">
                                    Описание
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pending Payment Tab -->
                <div class="tab-pane fade" id="payment" role="tabpanel">
                    @foreach (var order in Model.PendingPaymentOrders)
                    {
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Order #@order.Id.ToString().Substring(0, 8)</span>
                                <span class="badge bg-danger">@order.PaymentState</span>
                            </div>
                            <div class="card-body">
                                <form method="post" asp-page-handler="ConfirmPayment">
                                    <input type="hidden" asp-for="ConfirmOrderId" value="@order.Id" />
                                    <button type="submit" class="btn btn-success">Подтвердить оплату</button>
                                </form>
                            </div>
                        </div>
                    }
                </div>

                <!-- Rent Orders Tab -->
                <div class="tab-pane fade" id="rent" role="tabpanel">
                    @foreach (var order in Model.RentOrders)
                    {
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Order #@order.Id.ToString().Substring(0, 8)</span>
                                <span class="badge @GetRentStatusBadge(order)">@GetRentStatus(order)</span>
                            </div>
                            <div class="card-body">
                                <p>Rent Period: @order.StartRentDate?.ToString("d") - @order.EndRentDate?.ToString("d")</p>
                                
                                <button type="button" class="btn btn-info btn-sm" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#descriptionModal-@order.Id">
                                    Описание
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetRentStatus(OrderBaseDto order)
    {
        if (order.PaymentState == PaymentStatus.PaymentConfirmation)
            return "Pending Confirmation";

        if (DateTime.Now > order.EndRentDate?.ToDateTime(TimeOnly.MinValue))
            return "Overdue";

        return order.PaymentState.ToString();
    }

    private string GetRentStatusBadge(OrderBaseDto order)
    {
        return GetRentStatus(order) switch
        {
            "Overdue" => "bg-danger",
            "Pending Confirmation" => "bg-warning",
            "Paid" => "bg-success",
            _ => "bg-secondary"
        };
    }
}

@section Scripts {
    <script>
        // Глобальные данные для категорий и продуктов
        const subcategories = @Html.Raw(Json.Serialize(Model.Subcategories));
        const products = @Html.Raw(Json.Serialize(Model.Products));

        function updateSubcategories(orderId) {
            const categoryId = document.getElementById('categorySelect-' + orderId).value;
            const subcatSelect = document.getElementById('subcategorySelect-' + orderId);
            subcatSelect.innerHTML = '';
            
            if (!categoryId) {
                subcatSelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
                updateProducts(orderId);
                return;
            }

            if (subcategories[categoryId] && subcategories[categoryId].length > 0) {
                subcategories[categoryId].forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.Id;
                    option.textContent = s.Name;
                    subcatSelect.appendChild(option);
                });
            } else {
                subcatSelect.innerHTML = '<option value="">Нет подкатегорий</option>';
            }
            
            updateProducts(orderId);
        }

        function updateProducts(orderId) {
            const subcategoryId = document.getElementById('subcategorySelect-' + orderId).value;
            const productSelect = document.getElementById('productSelect-' + orderId);
            productSelect.innerHTML = '';
            
            if (!subcategoryId) {
                productSelect.innerHTML = '<option value="">Сначала выберите подкатегорию</option>';
                return;
            }

            if (products[subcategoryId] && products[subcategoryId].length > 0) {
                products[subcategoryId].forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.Id;
                    option.textContent = p.Name + ' (' + p.Price + ' ₽)';
                    productSelect.appendChild(option);
                });
            } else {
                productSelect.innerHTML = '<option value="">Нет товаров</option>';
            }
        }
    </script>
}