@page
@using SemataryFabrick.Domain.Entities.Enums
@using SemataryFabrick.Domain.Entities.Models.UserModels
@model SemataryFabrikUI.Pages.Dashboard.OrderMangerModel
@{
    ViewData["Title"] = "Order Manager";
    Layout = "~/Pages/Dashboard/_DashboardLayout.cshtml";
}

<div class="">
    <div class="pc-content">
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <h5 class="mb-1">Менеджер заказов</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#new-orders">
                            Новые заказы (@Model.NewOrders.Count)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#in-progress">
                            В исполнении (@Model.InProgressOrders.Count)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#payment-confirmation">
                            Ожидают подтверждения оплаты (@Model.PaymentConfirmationOrders.Count)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#rent-orders">
                           Заказы Аренды (@Model.RentOrders.Count)
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    <!-- New Orders Tab -->
                    <div class="tab-pane fade show active" id="new-orders">
                        @foreach (var order in Model.NewOrders)
                        {
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Заказ #@order.Id.ToString().Substring(0, 8)</h5>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <p class="mb-1">
                                                <strong>Клиент:</strong><br>
                                                @if (order.Customer is LegalCustomer)
                                                {
                                                    @((order.Customer as LegalCustomer)?.CompanyName)
                                                }
                                                else
                                                {
                                                    @order.Customer.FirstName @order.Customer.LastName
                                                }
                                            </p>
                                            <p class="mb-1">
                                                <strong>Сумма:</strong> @order.TotalPrice.ToString("C")
                                            </p>
                                        </div>
                                        <div class="col-md-3">
                                            <form method="post" class="d-inline">
                                                <input type="hidden" name="id" value="@order.Id" />
                                                <button type="submit"
                                                        asp-page-handler="ApproveOrder"
                                                        class="btn btn-success btn-sm"
                                                        onclick="return confirm('Approve this order?')">
                                                    Утвердить
                                                </button>
                                                <button type="submit"
                                                        asp-page-handler="RejectOrder"
                                                        class="btn btn-danger btn-sm"
                                                        onclick="return confirm('Reject this order?')">
                                                    Отклонить
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button class="btn btn-primary btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editOrderModal"
                                                    data-order-id="@order.Id">
                                                Редактировать
                                            </button>
                                            <button class="btn btn-info btn-sm items-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#orderItemsModal"
                                                    data-order-id="@order.Id">
                                                Оборудование (@order.OrderItems.Count)
                                            </button>
                                            <button class="btn btn-success btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#addItemModal"
                                                    data-order-id="@order.Id">
                                                Добавить тов. позицию 
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- In Progress Tab -->
                    <div class="tab-pane fade" id="in-progress">
                        @foreach (var order in Model.InProgressOrders)
                        {
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Заказ #@order.Id.ToString().Substring(0, 8)</h5>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p class="mb-1">
                                                <strong>Статус:</strong> @order.OrderState
                                            </p>
                                            <p class="mb-1">
                                                <strong>Тех специалист:</strong>
                                                @order.TechOrderLead.FirstName @order.TechOrderLead.LastName
                                            </p>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="progress mb-2">
                                                @{
                                                    var tasks = order.OrderCrews?
                                                    .SelectMany(oc => oc.WorkTaskAssignments)
                                                    .ToList();
                                                    var completed = tasks?.Count(t => t.IsCompleted) ?? 0;
                                                    var total = tasks?.Count ?? 0;
                                                }
                                                    <div class="progress-bar" 
                                                         role="progressbar"
                                                     style="width: @(total > 0 ? (completed * 100 / total) : 0)%; height: 100%; line-height: 25px; height: 25px;">
                                                    @completed/@total Задач выполнено
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            @if (order.OrderState == OrderState.ProccessedByTechLead)
                                            {
                                                <form method="post">
                                                    <input type="hidden" name="id" value="@order.Id" />
                                                    <button type="submit"
                                                            asp-page-handler="ProcessOrder"
                                                            class="btn btn-warning btn-sm"
                                                            onclick="return confirm('Пометить как исполненный?')">
                                                        Пометить как исполненный
                                                    </button>
                                                </form>
                                            }
                                            <button class="btn btn-info btn-sm items-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#orderItemsModal"
                                                    data-order-id="@order.Id">
                                                Оборудование (@order.OrderItems.Count)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Payment Confirmation Tab -->
                    <div class="tab-pane fade" id="payment-confirmation">
                        @foreach (var order in Model.PaymentConfirmationOrders)
                        {
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Заказ #@order.Id.ToString().Substring(0, 8)</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <strong>Итого:</strong> @order.TotalPrice.ToString("C")
                                            </p>
                                            <p class="mb-1">
                                                <strong>Статус оплаты:</strong> @order.PaymentState
                                            </p>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <form method="post">
                                                <input type="hidden" name="id" value="@order.Id" />
                                                <button type="submit"
                                                        asp-page-handler="ConfirmPayment"
                                                        class="btn btn-success btn-sm"
                                                        onclick="return confirm('Confirm payment received?')">
                                                    Потвердить оплату
                                                </button>
                                            </form>
                                            <button class="btn btn-info btn-sm items-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#orderItemsModal"
                                                    data-order-id="@order.Id">
                                                Оборудование (@order.OrderItems.Count)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Rent Orders Tab -->
                    <div class="tab-pane fade" id="rent-orders">
                        @foreach (var order in Model.RentOrders)
                        {
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Order #@order.Id.ToString().Substring(0, 8)</h5>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p class="mb-1">
                                                <strong>Период аренды:</strong><br>
                                                @order.StartRentDate?.ToShortDateString() -
                                                @order.EndRentDate?.ToShortDateString()
                                            </p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-1">
                                                <strong>Статус:</strong> @order.PaymentState
                                            </p>
                                            @if (order.PaymentState == PaymentStatus.Paid)
                                            {
                                                <span class="badge bg-success">Активно</span>
                                            }
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-info btn-sm items-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#orderItemsModal"
                                                    data-order-id="@order.Id">
                                                Items (@order.OrderItems.Count)
                                            </button>
                                            @if (DateTime.Now > order.EndRentDate?.ToDateTime(TimeOnly.MinValue))
                                            {
                                                <span class="badge bg-danger">Просрочено</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Order Modal -->
<div class="modal fade" id="editOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="SelectedOrderId"/>

                    <div class="mb-3">
                        <label class="form-label">Технический специалист</label>
                        <select asp-for="SelectedTechLeadId" asp-items="Model.TechLeads"
                                class="form-select"></select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Total Price</label>
                        <input asp-for="NewTotalPrice" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" asp-page-handler="UpdateTechLead"
                            class="btn btn-primary">
                        Обновить тех специалиста
                    </button>
                    <button type="submit" asp-page-handler="UpdatePrice"
                            class="btn btn-primary">
                        Обновить итоговую цену
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Order Items Modal -->
<div class="modal fade" id="orderItemsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Items</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Товар</th>
                            <th>Цена</th>
                            <th>Количество</th>
                            <th>Итоговая цена</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="orderItemsBody">
                        @* Данные будут загружаться динамически через JavaScript *@
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" id="addItemForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="SelectedOrderId" id="SelectedOrderIdInput" />

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Category</label>
                            <select asp-for="SelectedCategoryId"
                                    id="SelectedCategoryId"
                                    class="form-select"
                                    onchange="loadSubCategories(this.value)">
                                <option value="">Select Category</option>
                                @foreach (var category in Model._db.ProductCategories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Subcategory</label>
                            <select asp-for="SelectedSubCategoryId"
                                    class="form-select"
                                    id="subCategorySelect"
                                    onchange="loadItems(this.value)"
                                    disabled>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Item</label>
                            <select asp-for="SelectedItemId"
                                    class="form-select"
                                    id="itemSelect"
                                    disabled>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Quantity</label>
                            <input asp-for="Quantity"
                                   class="form-control"
                                   id="Quantity"
                                   type="number"
                                   min="1"
                                   max="100"
                                   value="1" />
                            <span asp-validation-for="Quantity" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit"
                            asp-page-handler="AddItem"
                            class="btn btn-primary">
                        Добавить новую позицию
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Инициализация модальных окон
        document.addEventListener('DOMContentLoaded', function() {
            // Обработка выбора заказа
            document.querySelectorAll('[data-bs-toggle="modal"]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    const orderIdInput = document.getElementById('SelectedOrderId');

                    if (orderIdInput) {
                        orderIdInput.value = orderId;
                        console.log('Установлен OrderId:', orderId);
                    } else {
                        console.error('Элемент SelectedOrderId не найден');
                    }
                });
            });
        });

        document.getElementById('addItemModal').addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const orderId = button.dataset.orderId;

                    // 4. Устанавливаем ID заказа в скрытое поле
                    document.getElementById('SelectedOrderIdInput').value = orderId;
                    console.log('Order ID установлен:', orderId);

                    // 5. Сбрасываем форму и выпадающие списки
                    const form = document.getElementById('addItemForm');
                    form.reset();

                    // Сбрасываем подкатегории
                    const subCategorySelect = document.getElementById('subCategorySelect');
                    subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                    subCategorySelect.disabled = true;

                    // Сбрасываем товары
                    const itemSelect = document.getElementById('itemSelect');
                    itemSelect.innerHTML = '<option value="">Select Item</option>';
                    itemSelect.disabled = true;

                    // Сбрасываем валидацию
                    const validationSpan = document.querySelector('span[data-valmsg-for="Quantity"]');
                    if (validationSpan) validationSpan.textContent = '';
                });

        // Динамическая загрузка подкатегорий
        function loadSubCategories(categoryId) {
            const subCategorySelect = document.getElementById('subCategorySelect');
            if (!categoryId) {
                subCategorySelect.disabled = true;
                return;
            }

            fetch(`?handler=SubCategories&categoryId=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    subCategorySelect.innerHTML = data.reduce((acc, item) =>
                        acc + `<option value="${item.id}">${item.name}</option>`,
                        '<option value="">Select Subcategory</option>'
                    );
                    subCategorySelect.disabled = false;
                });
        }

        function loadItems(subCategoryId) {
            const itemSelect = document.getElementById('itemSelect');
            if (!subCategoryId) {
                itemSelect.disabled = true;
                return;
            }

            fetch(`?handler=Items&subCategoryId=${subCategoryId}`)
                .then(response => response.json())
                .then(data => {
                    itemSelect.innerHTML = data.reduce((acc, item) =>
                        acc + `<option value="${item.id}">${item.name} (${item.price})</option>`,
                        '<option value="">Select Item</option>'
                    );
                    itemSelect.disabled = false;
                });
        }

        document.getElementById('addItemForm').addEventListener('submit', function(e) {
            const itemSelect = document.getElementById('itemSelect');
            if (!itemSelect.value) {
                e.preventDefault();
                alert('Пожалуйста, выберите товар');
                return false;
            }
            return true;
        });

        // Валидация выбора товара
        function validateItemSelection() {
            const itemSelect = document.getElementById('itemSelect');
            if (!itemSelect.value) {
                alert('Please select an item');
                return false;
            }
            return true;
        }

    </script>

    <script>
        // Обработчик открытия модального окна
        document.getElementById('orderItemsModal').addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const orderId = button.getAttribute('data-order-id');

            // Очищаем предыдущие данные
            document.getElementById('orderItemsBody').innerHTML = '';

            // Загружаем данные для выбранного заказа
            fetch(`?handler=OrderItems&orderId=${orderId}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.productName}</td>
                                <td>${item.price}</td>
                                <td>${item.quantity}</td>
                                <td>${item.total}</td>
                                <td>
                                    <form method="post">
                                        <input type="hidden" name="orderId" value="${orderId}" />
                                        <button type="submit"
                                                asp-page-handler="RemoveItem"
                                                class="btn btn-danger btn-sm"
                                                name="itemId"
                                                value="${item.id}"
                                                onclick="return confirm('Убрать товар?')">
                                            Remove
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        `;
                    });
                    document.getElementById('orderItemsBody').innerHTML = html;
                });
        });
    </script>
}